// Replace with your threat hunting team's email address
const THREAT_HUNTING_TEAM_EMAIL = "threat-hunting-team@example.com";

function onFormSubmit(e) {
  if (!e || !e.response) {
    Logger.log("No response data found.");
    return;
  }

  // Get the form and its name
  const form = FormApp.getActiveForm();
  const formName = form.getTitle();
  const timestamp = new Date(); // Capture submission time

  // Get the response data
  const response = e.response;
  const items = form.getItems();

  // Initialize variables
  let emailBody = `<h2>New Threat Hunting Request: "${formName}"</h2>`;
  emailBody += `<p><strong>Submission Time:</strong> ${timestamp.toLocaleString()}</p>`;
  emailBody += `<table border='1' style='border-collapse:collapse; width:100%;'>`;

  let requestorEmail = "";
  let priority = "Medium"; // Default priority

  items.forEach((item) => {
    const question = item.getTitle();
    const responseItem = response.getResponseForItem(item);
    const responseText = responseItem ? responseItem.getResponse() : "No response";

    // Capture requestor's email and priority if available
    if (question.toLowerCase().includes("email")) {
      requestorEmail = responseText;
    }
    if (question.toLowerCase().includes("priority")) {
      priority = responseText;
    }

    // Add question and response to the email body
    emailBody += `
      <tr>
        <td style="padding:8px; width:30%; background-color:#f4f4f4;"><strong>${question}</strong></td>
        <td style="padding:8px; width:70%;">${responseText}</td>
      </tr>`;
  });

  emailBody += `</table>`;

  // Highlight priority
  emailBody += `
    <p><strong>Priority:</strong> <span style="color:${priority === "High" ? "red" : "black"};">${priority}</span></p>`;

  // Add footer with additional details
  emailBody += `
    <p><strong>Next Steps:</strong></p>
    <ul>
      <li>Review the request details.</li>
      <li>Analyze any attached logs or reports.</li>
      <li>Contact the requestor at ${requestorEmail || "N/A"} for clarification, if needed.</li>
      <li>Escalate critical issues to the appropriate team.</li>
    </ul>
    <p><em>This email was auto-generated by the Threat Hunting Request Form. For questions, contact support@example.com.</em></p>`;

  // Email options
  const emailSubject = `[${priority.toUpperCase()}] Threat Hunting Request`;
  const emailOptions = {
    htmlBody: emailBody,
  };

  // Send the email to the threat hunting team
  GmailApp.sendEmail(THREAT_HUNTING_TEAM_EMAIL, emailSubject, "", emailOptions);
}

// Installable trigger setup function
function setupTrigger() {
  const form = FormApp.getActiveForm();
  ScriptApp.newTrigger("onFormSubmit")
    .forForm(form)
    .onFormSubmit()
    .create();
}
